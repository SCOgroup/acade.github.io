{{/* layouts/people/single.html */}}
{{ define "main" }}
<article class="person-page" style="max-width:900px;margin:0 auto;padding:1rem;">
  <header style="display:flex;gap:1rem;align-items:center;">
    <div style="flex:0 0 160px;">
      {{/* 头像获取：优先 page bundle 中与 params.avatar 同名的资源，次优 params.avatar 字符串，最后尝试匹配 avatar*.* */}}
      {{ $thumb := "" }}
      {{ if isset .Params "avatar" }}
        {{ $avatarParam := .Params.avatar }}
        {{ with .Resources.Match $avatarParam }}
          {{ $thumb = .RelPermalink }}
        {{ else if .Resources.Match "avatar*.*" }}
          {{ $r := .Resources.Match "avatar*.*" }}
          {{ $thumb = $r.RelPermalink }}
        {{ else }}
          {{ $thumb = $avatarParam }}
        {{ end }}
      {{ else if .Resources.GetMatch "avatar*.*" }}
        {{ $r := .Resources.GetMatch "avatar*.*" }}
        {{ $thumb = $r.RelPermalink }}
      {{ end }}

      {{ if $thumb }}
        <img src="{{ $thumb }}" alt="{{ .Title }}" style="width:160px;height:160px;object-fit:cover;border-radius:8px;" />
      {{ else }}
        <div style="width:160px;height:160px;background:#eee;display:flex;align-items:center;justify-content:center;border-radius:8px;color:#999;">
          无头像
        </div>
      {{ end }}
    </div>

    <div style="flex:1;">
      <h1 style="margin:0 0 0.25rem 0;">{{ .Title }}</h1>
      {{ with .Params.role }}<div style="color:#444;margin-bottom:0.25rem;">{{ . }}</div>{{ end }}
      {{ with .Params.organization }}<div style="color:#666;margin-bottom:0.5rem;">{{ . }}</div>{{ end }}

      {{ with .Params.interests }}
        <div style="margin-top:0.25rem;">
          <strong>研究兴趣：</strong>
          {{ range $i, $it := . }}{{ if $i }}, {{ end }}{{ $it }}{{ end }}
        </div>
      {{ end }}

      {{ with .Params.tags }}
        <div style="margin-top:0.25rem;color:#666;">
          <strong>标签：</strong>
          {{ range $i, $t := . }}{{ if $i }}, {{ end }}{{ $t }}{{ end }}
        </div>
      {{ end }}
    </div>
  </header>

  <section style="margin-top:1rem;line-height:1.7;">
    {{ if .Content }}
      {{ .Content }}
    {{ else if .Params.summary }}
      <p>{{ .Params.summary }}</p>
    {{ end }}
  </section>

  <hr style="margin:2rem 0;" />

  {{/* 列出与当前 role 相同的其他成员（排除当前页面），按 group 分组显示 */}}
  <section>
    <h2>同组成员（按 group 分组）</h2>
    {{ $role := .Params.role }}
    {{ $others := where (where .Site.RegularPages "Type" "people") "Params.role" $role }}
    {{ $others = where $others "Permalink" "ne" .Permalink }}
    {{ if gt (len $others) 0 }}
      {{ range $groupName, $pages := group $others "Params.group" }}
        <div style="margin-top:0.75rem;">
          <h3 style="margin:0 0 0.5rem 0;">{{ if $groupName }}组别：{{ $groupName }}{{ else }}未分组{{ end }}</h3>
          <div style="display:flex;flex-wrap:wrap;gap:0.75rem;">
            {{ range $p := $pages }}
              {{ $pThumb := "" }}
              {{ if isset $p.Params "avatar" }}
                {{ $pAvatarParam := $p.Params.avatar }}
                {{ with $p.Resources.Match $pAvatarParam }}
                  {{ $pThumb = .RelPermalink }}
                {{ else if $p.Resources.Match "avatar*.*" }}
                  {{ $rp := $p.Resources.Match "avatar*.*" }}
                  {{ $pThumb = $rp.RelPermalink }}
                {{ else }}
                  {{ $pThumb = $pAvatarParam }}
                {{ end }}
              {{ else if $p.Resources.GetMatch "avatar*.*" }}
                {{ $rp := $p.Resources.GetMatch "avatar*.*" }}
                {{ $pThumb = $rp.RelPermalink }}
              {{ end }}

              <a href="{{ $p.RelPermalink }}" style="display:flex;align-items:center;gap:0.6rem;padding:0.4rem;border:1px solid #eee;border-radius:6px;text-decoration:none;color:inherit;width:320px;">
                <div style="width:56px;height:56px;flex:0 0 56px;">
                  {{ if $pThumb }}
                    <img src="{{ $pThumb }}" alt="{{ $p.Title }}" style="width:56px;height:56px;object-fit:cover;border-radius:6px;" />
                  {{ else }}
                    <div style="width:56px;height:56px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;border-radius:6px;color:#999;">无图</div>
                  {{ end }}
                </div>
                <div>
                  <div style="font-weight:600;">{{ $p.Title }}</div>
                  {{ with $p.Params.role }}<div style="color:#666;font-size:0.95rem;">{{ . }}</div>{{ end }}
                  {{ with $p.Params.interests }}<div style="color:#444;font-size:0.9rem;">{{ if gt (len .) 3 }}{{ (slice . 0 3) | join ", " }}{{ else }}{{ join ", " . }}{{ end }}</div>{{ end }}
                </div>
              </a>
            {{ end }}
          </div>
        </div>
      {{ end }}
    {{ else }}
      <p>暂无其他同 role 成员。</p>
    {{ end }}
  </section>
</article>
{{ end }}
